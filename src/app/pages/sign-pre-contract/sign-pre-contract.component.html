<mat-card class="p-4 shadow rounded-3" style="    padding: 20px !important;">

  <mat-card-title class="h5 mb-4 fw-semibold text-center">
    Sign Pre-Contract
  </mat-card-title>

  <!-- Customer + Loan Info -->
  <div class="p-3 border rounded bg-light mb-3" *ngIf="loan">
    <p class="mb-1"><strong>Customer:</strong> {{ loan.customer?.fullName }}</p>
    <p class="mb-1"><strong>Loan Amount:</strong> {{ loan.loanAmount| currency:'TND' }}</p>
    <p class="mb-0"><strong>Loan Type:</strong> {{ loan.creditType }}</p>
  </div>

  <!-- Step indicator -->
  <mat-progress-bar mode="determinate" value="25"></mat-progress-bar>
  <p class="text-center small mt-2">Step 1 of 4: Pre-Contract Signature</p>

  <!-- Document list -->
  <div *ngIf="!isLoading; else loading">
    <mat-list>
      <mat-list-item *ngFor="let doc of documents" class="d-flex justify-content-between align-items-center mb-2">
        <span class="fw-medium">{{ doc.name }}</span>
        <button mat-raised-button color="primary" class="ms-3" (click)="viewDocument(doc)">
          View
        </button>
      </mat-list-item>
    </mat-list>

  </div>

  <!-- Legal note -->
<!-- Legal note + signature block (CLIENT only) -->
<div *ngIf="role==='CLIENT' && !isSigned" class="mt-4">
  <div class="alert alert-info">
    <small>
      Please review all documents carefully before signing.
      By signing, you acknowledge that you have read and understood the terms and conditions.
    </small>
  </div>

  <h6 class="mb-3">Sign the contract</h6>

  <!-- Choice : draw or file -->
  <mat-button-toggle-group [(ngModel)]="mode" class="mb-3">
    <mat-button-toggle value="draw">Draw</mat-button-toggle>
    <mat-button-toggle value="file">Upload file</mat-button-toggle>
  </mat-button-toggle-group>

<!-- DRAW MODE -->
<div *ngIf="mode === 'draw'" class="text-center">
  <mat-card class="p-3 mb-3" style="border:2px dashed #ccc;border-radius:8px;">
    <signature-pad [options]="signaturePadOptions"
                   (onEndEvent)="drawComplete()">
    </signature-pad>
  </mat-card>
  <button mat-raised-button color="warn" (click)="clearPad()">
    <i-tabler name="eraser" class="icon-18"></i-tabler> Clear
  </button>
</div>

<!-- FILE MODE -->
<div *ngIf="mode === 'file'" class="text-center">
  <mat-card class="p-4 mb-3" style="border:2px dashed #1976f2;border-radius:8px;background:#f5faff;">
    <input type="file" accept="image/*" (change)="onFileSelected($event)"
           class="d-none" #fileInput>
    <button mat-raised-button color="primary" (click)="fileInput.click()">
      <i-tabler name="upload" class="icon-18"></i-tabler> Choose File
    </button>
    <div class="mt-2 text-muted small">PNG, JPG â‰¤ 2 MB</div>
  </mat-card>
</div>
  <!-- Preview (both modes) -->
  <div *ngIf="signaturePreview" class="mt-3 text-center">
    <h6>Preview:</h6>
    <img [src]="signaturePreview" width="200" class="border p-2" />
  </div>

  <!-- Sign button -->
  <div class="mt-3 text-center">
    <button mat-raised-button color="accent"
            (click)="saveSignature()"
            [disabled]="!signatureFile && !drawnSignature">
      Sign Contract
    </button>
  </div>
</div>

<!-- Support (always visible) -->
<div class="mt-4 text-center text-muted small">
  Need help? Contact your branch at <strong>71 123 456</strong>
  or email <a href="mailto:support@stb.com.tn">support@stb.com.tn</a>.
</div>  
<div *ngIf="role=='BANQUIER'" class="mt-4" style="text-align: end;">
  <button type="button" mat-raised-button color="warn" (click)="rejectLoan()" style="margin-right: 8px;">
    Rejeter
  </button>
  <button type="button" mat-raised-button color="primary" (click)="nextStep()">
    Accepter
  </button>
</div>
  <!-- Loader -->
  <ng-template #loading>
    <div class="d-flex justify-content-center align-items-center p-4">
      <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
    </div>
  </ng-template>
</mat-card>